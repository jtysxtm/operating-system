# lab2

对实验报告的要求：
 - 基于markdown格式来完成，以文本方式为主
 - 填写各个基本练习中要求完成的报告内容
 - 完成实验后，请分析ucore_lab中提供的参考答案，并请在实验报告中说明你的实现与参考答案的区别
 - 列出你认为本实验中重要的知识点，以及与对应的OS原理中的知识点，并简要说明你对二者的含义，关系，差异等方面的理解（也可能出现实验中的知识点没有对应的原理知识点）
 - 列出你认为OS原理中很重要，但在实验中没有对应上的知识点

## EX1：理解first-fit 连续物理内存分配算法（思考题）
<!--first-fit 连续物理内存分配算法作为物理内存分配一个很基础的方法，需要同学们理解它的实现过程。请大家仔细阅读实验手册的教程并结合`kern/mm/default_pmm.c`中的相关代码，认真分析default_init，default_init_memmap，default_alloc_pages， default_free_pages等相关函数，并描述程序在进行物理内存分配的过程以及各个函数的作用。
请在实验报告中简要说明你的设计实现过程。请回答如下问题：
- 你的first fit算法是否有进一步的改进空间？-->

### 相关函数及其作用

- default_init函数
  - 物理内存管理器的初始化函数。用于初始化空闲内存块列表 free_list 并将空闲内存块数量 nr_free 设置为0。
  - 这个函数在系统启动时调用，一次性初始化物理内存管理器。

- default_init_memmap函数
  - 用于初始化内存映射。在系统启动时，内核需要知道哪些物理页面是可用的，default_init_memmap函数被用于初始化这些可用页面。
  - 遍历一个内存块中的每一页，初始化每一页的属性，包括标志 flags 和属性 property；然后将引用计数 ref 设置为0，并将这些页面添加到 free_list 列表中，以表示它们是可用的；更新 nr_free 变量，表示可用页面的总数量。

- default_alloc_pages函数
  - 用于分配指定数量的物理页面，实现了第一适应内存分配算法。
  - 遍历 free_list 列表，查找第一个满足需求的空闲块，即可用页面数量大于或等于请求的数量 n。如果找到满足条件的块，分配其中的页面，并将剩余的页面添加回 free_list 列表。如果没有找到满足条件的块，返回NULL。

- default_free_pages函数
  - 用于释放一组连续的物理页面。
  - 将这些页面添加回 free_list 列表，并尝试合并相邻的空闲块，以最大程度地减少碎片化；更新 nr_free 变量以反映可用页面的数量。

- default_nr_free_pages函数
  - 用于查询可用页面的数量。
  - 返回 nr_free 变量的值，表示当前系统中可用的物理页面数量。

- default_check函数
  - 用于检查物理内存管理器的正确性。
  - 执行一系列内存分配和释放操作，并检查各个步骤的结果是否符合预期。这有助于确保物理内存管理器的正确性和稳定性。

### 实现过程设计

设计实现过程应该包括以下步骤：
1. 初始化物理内存管理器，设置 free_list 和 nr_free 。
2. 在系统启动时，通过调用 default_init_memmap 函数初始化可用的物理页面。
3. 在进程或内核代码中，使用 default_alloc_pages 函数来分配物理页面，并使用  default_free_pages 函数来释放页面。
4. 定期调用 default_check 函数来检查物理内存管理器的正确性，以确保它正常工作。

### 改进空间

- 碎片化问题
  - 第一适应算法可能导致外部碎片的积累，因为它不够智能，只是找到第一个满足需求的块。
  - 一个可能的改进是使用更高级的分配策略，如Best-Fit、Next-Fit、伙伴系统等，这些算法尝试选择尺寸更接近请求的块，从而减少碎片化。

- 开销
  - 每次都是从低址部分查找，使得查找空闲分区的开销增大；每次查询第一块符合条件的空闲内存块时，最坏情况需要找遍整个链表，时间复杂度是O（N）。
  - 尝试使用平衡二叉树等结构维护空闲块，其中按照中序遍历得到的空闲块序列的物理地址恰好按照从小到大排序，每个二叉树节点上维护该节点为根的子树上的最大的空闲块的大小。使用二分查找查找到物理地址最小的能够满足条件的空闲地址块。

## EX2：实现 Best-Fit 连续物理内存分配算法（需要编程）
<!--在完成练习一后，参考kern/mm/default_pmm.c对First Fit算法的实现，编程实现Best Fit页面分配算法，算法的时空复杂度不做要求，能通过测试即可。
请在实验报告中简要说明你的设计实现过程，阐述代码是如何对物理内存进行分配和释放，并回答如下问题：
- 你的 Best-Fit 算法是否有进一步的改进空间？-->





## 扩展练习Challenge：buddy system（伙伴系统）分配算法（需要编程）

Buddy System算法把系统中的可用存储空间划分为存储块(Block)来进行管理, 每个存储块的大小必须是2的n次幂(Pow(2, n)), 即1, 2, 4, 8, 16, 32, 64, 128...

 -  参考[伙伴分配器的一个极简实现](http://coolshell.cn/articles/10427.html)， 在ucore中实现buddy system分配算法，要求有比较充分的测试用例说明实现的正确性，需要有设计文档。
 
## 扩展练习Challenge：任意大小的内存单元slub分配算法（需要编程）

slub算法，实现两层架构的高效内存单元分配，第一层是基于页大小的内存分配，第二层是在第一层基础上实现基于任意大小的内存分配。可简化实现，能够体现其主体思想即可。

 - 参考[linux的slub分配算法/](http://www.ibm.com/developerworks/cn/linux/l-cn-slub/)，在ucore中实现slub分配算法。要求有比较充分的测试用例说明实现的正确性，需要有设计文档。

## 扩展练习Challenge：硬件的可用物理内存范围的获取方法（思考题）
  - 如果 OS 无法提前知道当前硬件的可用物理内存范围，请问你有何办法让 OS 获取可用物理内存范围？


> Challenges是选做，完成Challenge的同学可单独提交Challenge。完成得好的同学可获得最终考试成绩的加分。